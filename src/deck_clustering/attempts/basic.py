""" Weighted Jaccard Similarity for Hierarchical Agglomerative Clustering



I have given number of lists of elements that are chosen from a universe of more or less 150 elements.
Each list is identified by a unique code and contains 30 elements and each element can appear no more than 2 times in each list.
I'd like to cluster these lists by similarity (two lists are similar if they contain similar elements).
See below:

codes = ('5899', '5929', '5985', '6020', '10823', '11200', '11780', '12526', '12576', '26270', '27910', '30287', '31636', '38175', '39094', '40536', '43662', '5941', '7735', '9594', '10487', '11315', '11326', '11446', '14817', '15294', '15574', '17994', '17999', '25909', '26205', '28708', '29657', '7951', '8740', '10321', '11124', '11163', '11198', '11548', '12889', '14228', '19128', '20271', '22063', '22687', '28795', '30499', '30589', '42350', '45391', '47348', '48703')
lists = (
    ['01079', '01079', '01080', '01080', '01089', '01089', '01090', '01090', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02192', '02192', '02227', '02227', '02229', '02229', '02234', '02234', '03231', '03231', '04034', '04034', '04036', '04036'],
	['01074', '01074', '01079', '01079', '01080', '01080', '01089', '01089', '01090', '01090', '01093', '01093', '02032', '02032', '02033', '02033', '02190', '02190', '02227', '02227', '02234', '02234', '03039', '03039', '03114', '03114', '03231', '03231', '04036', '04036'],
	['01053', '01053', '01067', '01067', '01080', '01080', '01087', '01087', '01093', '01093', '02032', '02032', '02033', '02033', '02116', '02116', '02234', '02234', '03039', '03039', '03114', '03114', '03198', '03198', '03228', '03228', '03231', '03231', '03272', '03272'],
	['01074', '01074', '01079', '01079', '01084', '01084', '01090', '01090', '01093', '01093', '02032', '02032', '02190', '02190', '02227', '02227', '02309', '02309', '03039', '03039', '03228', '03228', '03273', '03273', '03315', '03315', '04035', '04035', '04036', '04036'],
	['01053', '01053', '01067', '01067', '01087', '01087', '01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02192', '02192', '02227', '02227', '02229', '02229', '02234', '02234', '03039', '03039'],
	['01053', '01053', '01067', '01067', '01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02190', '02190', '02227', '02227', '02229', '02229', '03231', '03231', '04192', '04192', '05022', '05022', '05026', '05026', '05030', '05030'],
	['01080', '01080', '01087', '01087', '02033', '02033', '02227', '02227', '02229', '02229', '03039', '03039', '03231', '03231', '04153', '04153', '04201', '04201', '05022', '05022', '05036', '05036', '05114', '05114', '05119', '05119', '05159', '05159', '05160', '05160'],
	['01067', '01067', '01081', '01081', '02032', '02032', '02190', '02190', '02192', '02192', '02227', '02227', '02229', '02229', '02234', '02234', '03039', '03039', '03231', '03231', '04036', '04036', '04112', '04112', '04153', '04153', '04192', '04192', '05119', '05119'],
	['01067', '01067', '01080', '01080', '01093', '01093', '02032', '02032', '02190', '02190', '02229', '02229', '02234', '02234', '03036', '03036', '03039', '03039', '03116', '03116', '03198', '03198', '03231', '03231', '05022', '05022', '05036', '05036', '05119', '05119'],
	['01067', '01067', '01079', '01079', '01093', '01093', '02032', '02032', '02190', '02190', '02192', '02192', '02227', '02227', '04201', '04201', '05022', '05022', '05026', '05026', '05119', '05119', '06166', '06166', '06204', '06204', '60505', '60505', '60508', '60508'],
	['01079', '01079', '01080', '01080', '02032', '02032', '02033', '02033', '02192', '02192', '02227', '02227', '02234', '02234', '03039', '03039', '03114', '03114', '03116', '03116', '04200', '04200', '05160', '05160', '07121', '07121', '60317', '60317', '60507', '60507'],
	['01067', '01067', '01087', '01087', '01089', '01089', '01090', '01090', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02229', '02229', '02234', '02234', '03116', '03116', '03198', '03198', '04112', '04112', '05117', '05117', '05119', '05119'],
	['01093', '01093', '02026', '02035', '02035', '02158', '02190', '02190', '02192', '02192', '02193', '02227', '02227', '02229', '02229', '03039', '03039', '03273', '03273', '04201', '04201', '05036', '05036', '05114', '05114', '05159', '05159', '05324', '05324', '06111', '06111', '06166', '06166', '06167', '07083', '07179', '07180', '07181', '60507', '60507', '60524', '60524'],
	['01080', '01080', '01089', '01089', '02033', '02033', '02190', '02190', '03114', '03114', '03116', '03116', '03118', '03118', '04037', '04037', '04112', '04112', '04200', '04200', '04201', '04201', '05114', '05114', '06165', '06165', '07196', '07196', '08074', '08074', '08125'],
	['01091', '01091', '02035', '02158', '02158', '02229', '02229', '02235', '02265', '03039', '03039', '03228', '03228', '03273', '03273', '04153', '04153', '04198', '04200', '04200', '04201', '04201', '05036', '05159', '05159', '05324', '05324', '06111', '06111', '06159', '06165', '06165', '06166', '06166', '06167', '06167', '06204', '06204', '08071', '08125', '53011', '53011', '60317', '60317', '60524', '60524'],
	['01080', '01080', '01081', '01081', '01093', '01093', '02033', '02033', '02227', '02227', '02229', '02229', '03039', '03039', '03231', '03231', '04112', '04112', '04201', '04201', '05119', '05119', '05160', '05160', '07034', '07034', '07121', '07121', '60505', '60505'],
	['01073', '01073', '02033', '02033', '02158', '03038', '03038', '03039', '03039', '03114', '03114', '03118', '03118', '03119', '03119', '04035', '04035', '04112', '04112', '05036', '05036', '08072', '08072', '08107', '08107', '08116', '08116', '08125', '09119', '09119', '60317', '60317'],
	['01067', '01067', '01080', '01080', '01089', '01089', '01090', '01090', '01091', '01092', '02032', '02032', '02033', '02033', '02155', '02155', '02227', '02227', '02234', '02234', '03039', '03039', '03114', '03114', '03198', '03198', '03228', '03228', '03231', '03231'],
	['01067', '01074', '01088', '01088', '01089', '01089', '01091', '01091', '02032', '02032', '02033', '02033', '02227', '02227', '02229', '02229', '03036', '03036', '03039', '03039', '03114', '03114', '04033', '04033', '04112', '04112', '04201', '04201', '04272', '04272'],
	['01074', '01074', '01079', '01079', '01080', '01080', '01086', '01086', '01088', '01088', '01089', '01090', '01090', '01093', '01093', '02033', '02033', '02227', '02227', '02229', '03039', '03039', '03114', '03114', '03231', '03231', '04200', '04200', '05036', '05036'],
	['01074', '01074', '01079', '01079', '01080', '01080', '01087', '01087', '01089', '01089', '01090', '01091', '01093', '01093', '02032', '02032', '02033', '02033', '02227', '02227', '02234', '02234', '03039', '03039', '04200', '04200', '04201', '04201', '05038', '05038'],
	['01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02155', '02227', '02227', '02229', '02229', '02234', '02234', '03037', '03037', '03039', '03114', '03114', '03198', '03198', '03231', '03231'],
	['01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02155', '02227', '02227', '02229', '02229', '02234', '02234', '03037', '03037', '03039', '03114', '03114', '03198', '03198', '03231', '03231'],
	['01079', '01079', '01080', '01080', '01081', '01087', '01087', '01093', '01093', '02032', '02032', '02229', '02229', '03039', '03039', '03198', '03198', '03231', '03231', '04112', '04200', '04200', '04201', '04201', '05026', '05026', '05119', '05119', '05159', '05159'],
	['01067', '01067', '01080', '01080', '02192', '02192', '02227', '02227', '02229', '02229', '02234', '03039', '03039', '03198', '03198', '03231', '03231', '04200', '04200', '04201', '04201', '05038', '05038', '05114', '05114', '05119', '05159', '05159', '05281', '05281'],
	['01087', '01087', '01089', '01089', '01090', '01090', '01091', '01091', '01093', '01093', '02032', '02032', '02033', '02033', '02234', '02234', '02272', '02272', '03039', '03039', '03114', '03114', '03116', '03117', '03198', '03198', '03231', '03231', '04200', '04200'],
	['01080', '01080', '01087', '01087', '02032', '02032', '02033', '02033', '02227', '02227', '02234', '02234', '03037', '03037', '03039', '03039', '03231', '03272', '03272', '04153', '04153', '04201', '05022', '05022', '05036', '05036', '05119', '05119', '05160', '05160'],
	['01079', '01079', '01080', '01080', '01089', '01089', '01090', '01090', '02032', '02032', '02192', '02192', '02229', '02229', '03039', '03039', '03114', '03198', '03198', '03228', '03228', '03231', '03231', '03273', '04200', '04200', '04272', '04272', '05159', '05159'],
	['01075', '01089', '01089', '01090', '01090', '02033', '02033', '02229', '02229', '02309', '02309', '03039', '03039', '03231', '03231', '03273', '03273', '04160', '04160', '04200', '04200', '04201', '04201', '04273', '04273', '05037', '05159', '05159', '51010', '51010'],
	['01079', '01079', '01080', '01080', '02033', '02033', '02227', '02227', '02229', '02229', '03039', '03039', '03272', '03272', '04153', '04153', '04201', '04201', '05036', '05036', '05114', '05114', '05119', '05119', '05160', '06111', '06111', '06165', '60507', '60507'],
	['01080', '01080', '01093', '01093', '02032', '02032', '02033', '02033', '02192', '02192', '02229', '02229', '02234', '02234', '03039', '03039', '03198', '03198', '03231', '03231', '03272', '04201', '04201', '05022', '05022', '05036', '06111', '06111', '06165', '06165'],
	['01079', '01079', '01080', '01080', '01093', '01093', '02192', '02227', '02227', '02229', '02229', '02234', '02234', '03039', '03039', '03116', '03116', '03231', '03231', '04111', '04111', '04153', '04153', '04201', '04201', '04272', '05022', '05022', '07121', '07121'],
	['01081', '01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02192', '02192', '02227', '02227', '02229', '02229', '03039', '03039', '03231', '03231', '04112', '04112', '04153', '04153', '05030', '05030', '05038', '05038', '60304', '60317'],
	['01075', '01079', '01079', '01080', '01080', '01093', '01093', '02032', '02032', '02227', '02227', '02268', '02268', '02309', '03039', '03039', '03198', '03237', '03237', '03273', '03273', '03313', '04033', '04033', '04198', '04198', '04200', '04200', '04201', '04201'],
	['01079', '01080', '01085', '01087', '01089', '01091', '01093', '02032', '02032', '02033', '02155', '02234', '02310', '02310', '03039', '03114', '03116', '03117', '03118', '03119', '03155', '03198', '03231', '03273', '03315', '04035', '04112', '04153', '04159', '04201'],
	['01074', '01077', '01079', '01079', '01080', '01080', '01087', '01088', '01089', '01090', '01092', '01093', '01093', '02032', '02033', '02234', '03036', '03039', '03039', '03114', '03237', '03272', '04111', '04112', '04200', '04272', '05026', '05026', '05038', '05038'],
	['01079', '01079', '01080', '01080', '01089', '01089', '01090', '01090', '01091', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02234', '02234', '03039', '03039', '03114', '03114', '03198', '03198', '03237', '03237', '04111', '05038', '05038', '05117'],
	['01074', '01074', '01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02190', '02227', '02229', '02229', '02234', '02234', '03114', '03114', '03116', '03198', '03198', '03231', '03231', '05022'],
	['01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02190', '02227', '02229', '02229', '02234', '02234', '03114', '03114', '03116', '03198', '03198', '03231', '03231', '05022', '05114', '05114'],
	['01089', '01089', '01090', '01090', '01091', '01091', '01092', '01092', '01093', '01093', '02032', '02032', '02033', '02033', '02227', '02227', '02229', '02229', '02234', '02234', '03039', '03114', '03114', '03198', '03198', '03231', '04112', '05114', '05114', '05119'],
	['01081', '02032', '02032', '02033', '02033', '02190', '02190', '02192', '02227', '02229', '02229', '02234', '02234', '03039', '03039', '03116', '03116', '03117', '03117', '03118', '03119', '03231', '03231', '04036', '04153', '04192', '05114', '05114', '05119', '05119'],
	['01087', '01087', '01090', '01090', '01091', '01091', '01092', '01093', '01093', '02036', '02116', '02227', '02227', '02229', '02229', '04033', '04036', '04036', '04111', '04111', '04112', '04112', '04272', '04274', '05114', '05114', '05117', '05117', '05119', '05119'],
	['01093', '01093', '02032', '02032', '02033', '02035', '02192', '02227', '02227', '02229', '02229', '02234', '02268', '02268', '03198', '04198', '04198', '04275', '05026', '05026', '05114', '05114', '05119', '05195', '06118', '06166', '06166', '06204', '06204', '51010'],
	['01089', '01093', '02032', '02035', '02116', '02156', '02193', '02227', '02229', '02234', '02268', '03037', '03039', '03114', '03157', '03228', '03237', '03315', '04036', '04111', '04112', '04198', '04201', '04203', '04276', '05036', '05039', '05160', '05323', '06165', '06165'],
	['01077', '02026', '02032', '02035', '02035', '02158', '02190', '02190', '02227', '02227', '02229', '02229', '03039', '03039', '03273', '04153', '04153', '04201', '04201', '04273', '04273', '05036', '05159', '05159', '05195', '05195', '05324', '05324', '06111', '06111', '06166', '06166', '06167', '51010', '51010', '60507', '60527'],
	['01067', '01067', '01079', '01079', '01080', '01080', '01081', '01086', '01089', '01089', '01091', '01091', '01092', '02032', '02032', '02033', '02033', '02190', '02190', '03037', '03037', '03039', '03039', '03114', '03114', '04112', '04200', '04200', '04201', '04201'],
	['01079', '01079', '01080', '01080', '01081', '01093', '01093', '02032', '02032', '03037', '03039', '03039', '04111', '04111', '04112', '04201', '04201', '04272', '04272', '05022', '05022', '05026', '05026', '05119', '05119', '06111', '06111', '07121', '60507', '60507'],
	['01080', '01080', '01081', '01081', '01093', '01093', '02033', '02033', '02227', '03039', '03039', '03114', '03114', '03116', '04111', '04153', '05022', '05022', '05114', '05114', '06111', '06111', '07034', '07034', '07035', '07035', '07036', '07036', '60507', '60507'],
	['01089', '01089', '01090', '01090', '01091', '02035', '02158', '02158', '02229', '02229', '02265', '03039', '03039', '03115', '03273', '03273', '04160', '04200', '04200', '04201', '04201', '04313', '05022', '05159', '05159', '06111', '06167', '06204', '06204', '06284', '06284', '06330', '06332', '53011', '53011', '60317', '60507', '60527'],
	['02229', '02229', '03039', '03039', '03231', '03231', '03239', '03239', '04160', '04201', '04201', '05036', '05159', '05159', '06111', '06111', '06166', '06166', '07034', '07034', '07122', '07196', '07196', '07197', '07197', '07272', '07272', '08114', '09112', '60529', '60529', '60530'],
	['01072', '01079', '01079', '01085', '01091', '01091', '01092', '01092', '02032', '02033', '02190', '02229', '03039', '03039', '03228', '04112', '04201', '04201', '05036', '05159', '05159', '06111', '06111', '07035', '07196', '08072', '08072', '09031', '09102', '60505'],
	['01074', '01079', '01079', '01080', '01080', '02227', '02229', '02229', '03039', '03039', '04037', '04037', '04201', '04201', '05037', '05114', '05114', '06118', '08072', '08072', '08073', '08073', '08125', '09102', '10031', '10031', '10112', '10116', '10116', '60507', '60507'],
	['01072', '01074', '01077', '01078', '01081', '01089', '01090', '02032', '02033', '02034', '02116', '02116', '02155', '02190', '02227', '02270', '02272', '03114', '03117', '03198', '04034', '04036', '04111', '04201', '04201', '07034', '07035', '09101', '09103', '09106'],
)
universe = sorted({e for l in lists for e in l})

What is the best strategy to cluster these lists by similarity, so that the resulting clusters group semantically similar lists.
"""
import json
import sys

import matplotlib.pyplot as plt
import numpy as np
from scipy.cluster.hierarchy import dendrogram
from scipy.cluster.hierarchy import fcluster
from scipy.cluster.hierarchy import linkage
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.metrics import pairwise_distances
from sklearn.metrics import silhouette_score
from sklearn.metrics.pairwise import cosine_similarity


# Step 2: Compute Weighted Jaccard Similarity
def weighted_jaccard(a, b):
    intersection = np.minimum(a, b).sum()
    union = np.maximum(a, b).sum()

    return intersection / union


def main() -> None:
    with open('clusters.json', 'r') as f:
        data = json.load(f)

    # codes = np.array([
    #     int(code) + 1
    #     for code, cluster in data.items()
    #     for _ in cluster
    # ])

    decks = {
        code: [
            card
            for card, occur in deck.items()
            for _ in range(1, occur + 1)
        ]
        for _, cluster in data.items()
        for code, deck in cluster.items()
    }
    labels, lists = zip(*decks.items())
    universe = sorted({e for l in lists for e in l})

    # Step 1: Convert to count vectors (60 x 300)
    vectorizer = CountVectorizer(vocabulary=universe, tokenizer=lambda x: x, lowercase=False)
    X = vectorizer.fit_transform(lists).toarray()

    # Compute pairwise cosine similarity
    similarity = cosine_similarity(X)
    # similarity = 1 - pairwise_distances(X, metric=weighted_jaccard)

    # Step 3: Hierarchical Clustering
    Z = linkage(similarity, method='average')
    plt.figure(figsize=(12, 6))
    dn = dendrogram(Z, labels=labels, leaf_rotation=90, leaf_font_size=12)
    plt.show()

    # Step 4: Extract clusters (e.g., 5 clusters)
    best_k, best_score = 2, -1
    max_clusters = len(set(dn['leaves_color_list']))
    for k in range(2, max_clusters + 1):
        clusters = fcluster(Z, t=k, criterion='maxclust')
        score = silhouette_score(X, clusters)
        # score = np.mean([np.mean(similarity[clusters == i][:, clusters == i]) for i in range(1, k + 1)])
        if score > best_score:
            best_k = k
            best_score = score

    print(f"Clusters: {best_k}, Silhouette Score: {best_score:.4f}", file=sys.stderr)
    clusters = fcluster(Z, t=best_k, criterion='maxclust')
    print(clusters)

    print('Done.')


if __name__ == '__main__':
    main()
